#!/usr/bin/env bash
#
# symlink git-stored dotfiles into home directory
# adapted from github.com/technomancy/dotfiles

set -o nounset
set -o errexit

TARGETS=$@
OS=`uname`
DF=$HOME/.dotfiles

check_targets()
{
    # if no target is specified, then re-link all
    if [[ "$TARGETS" == "" ]]; then
        TARGETS="$(/bin/ls ${DF})"
    fi
}

symlink()
{
    src=$1
    targ=$2
    # if we have a good source, target
    if [ ! -z "$src" ] && [ ! -z "$targ" ]; then
        if [ ! -h $targ ]; then
            # if it's not a symlink already...
            if [ -r $targ ]; then
                # but is there, then remove it
                rm -rf $targ
            fi
            # and symlink it
            echo "[LINK]  $targ"
            ln -s $src $targ
        fi
    fi
}

link_subdir()
{
    # called as link_subdir (bin|dot) sourcedir, where sourcedir is like "base/Darwin" or "base"
    local kind=$1
    local source_dir=${DF}/$2/${kind}
    local files=$(/bin/ls -a ${source_dir})
    local targ_dir="${HOME}"
    if [[ ! $kind == "dot" ]]; then
        targ_dir="${HOME}/${kind}"
    fi
    for src_f in $files; do
        local targ_f=`basename $src_f`
        if [[ ! ( $targ_f == "." || $targ_f == ".." ) ]]; then
            symlink ${source_dir}/${src_f} ${targ_dir}${targ_f}
        fi
    done
}

check_targets
# for every target
for target in $TARGETS; do
    # for every kind:
    for kind in dot bin; do
        # link generic and OS-specific files
        link_subdir $kind $target
        link_subdir $kind $target/$OS
    done
done
